import pandas as pd

from src.rsi_detector.analysis import get_best_valid_line


def test_no_data():
    df = pd.DataFrame()
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)
    assert len(best_lines) == 0


def test_good_setup():
    data = {
        "Date": [
            "2024-02-05",
            "2024-02-12",
            "2024-02-19",
            "2024-02-26",
            "2024-03-04",
            "2024-03-11",
            "2024-03-18",
            "2024-03-25",
            "2024-04-02",
            "2024-04-08",
        ],
        "Open": [25.4, 27.0, 26.8, 26.8, 25.8, 26.2, 26.0, 26.2, 25.2, 26.0],
        "High": [26.8, 27.0, 26.8, 26.8, 26.2, 26.6, 26.2, 26.2, 26.2, 26.2],
        "Low": [24.8, 25.4, 25.4, 25.4, 25.4, 25.4, 25.2, 25.2, 25.0, 25.0],
        "Close": [26.0, 26.4, 25.6, 25.8, 26.2, 26.2, 25.2, 26.0, 25.0, 25.0],
        "Volume": [657, 259, 383, 298, 83, 435, 420, 128, 1054, 175],
        "RSI": [80, 71, 48, 69, 51, 51, 68, 64, 75, 70],
        "ema5": [
            26.153542,
            26.235695,
            26.023796,
            25.949198,
            26.032798,
            26.088532,
            25.792355,
            25.861570,
            25,
            25.382920,
        ],
        "Volume_MA": [313.15, 322.90, 332.15, 325.55, 272.85, 292, 300, 300, 300, 300],
    }
    # we need a longer dataset for rolling windows
    for key, item in data.items():
        data[key] = item + item

    df = pd.DataFrame(data=data)
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)

    assert len(best_lines) != 0


def test_too_steep_down():
    data = {
        "Date": [
            "2024-02-05",
            "2024-02-12",
            "2024-02-19",
            "2024-02-26",
            "2024-03-04",
            "2024-03-11",
            "2024-03-18",
            "2024-03-25",
            "2024-04-02",
            "2024-04-08",
        ],
        "Open": [25.4, 27.0, 26.8, 26.8, 25.8, 26.2, 26.0, 26.2, 25.2, 26.0],
        "High": [26.8, 27.0, 26.8, 26.8, 26.2, 26.6, 26.2, 26.2, 26.2, 26.2],
        "Low": [24.8, 25.4, 25.4, 25.4, 25.4, 25.4, 25.2, 25.2, 25.0, 25.0],
        "Close": [26.0, 26.4, 25.6, 25.8, 26.2, 26.2, 25.2, 26.0, 25.0, 25.0],
        "Volume": [657, 259, 383, 298, 83, 435, 420, 128, 1054, 175],
        "RSI": [80, 71, 48, 69, 51, 51, 65, 60, 75, 70],
        "Volume_MA": [313.15, 322.90, 332.15, 325.55, 272.85, 292, 300, 300, 300, 300],
    }

    df = pd.DataFrame(data=data)
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)

    assert len(best_lines) == 0


def test_too_steep_up():
    data = {
        "Date": [
            "2024-02-05",
            "2024-02-12",
            "2024-02-19",
            "2024-02-26",
            "2024-03-04",
            "2024-03-11",
            "2024-03-18",
            "2024-03-25",
            "2024-04-02",
            "2024-04-08",
        ],
        "Open": [25.4, 27.0, 26.8, 26.8, 25.8, 26.2, 26.0, 26.2, 25.2, 26.0],
        "High": [26.8, 27.0, 26.8, 26.8, 26.2, 26.6, 26.2, 26.2, 26.2, 26.2],
        "Low": [24.8, 25.4, 25.4, 25.4, 25.4, 25.4, 25.2, 25.2, 25.0, 25.0],
        "Close": [26.0, 26.4, 25.6, 25.8, 26.2, 26.2, 25.2, 26.0, 25.0, 25.0],
        "Volume": [657, 259, 383, 298, 83, 435, 420, 128, 1054, 175],
        "RSI": [80, 71, 48, 60, 51, 51, 68, 64, 75, 78],
        "Volume_MA": [313.15, 322.90, 332.15, 325.55, 272.85, 292, 300, 300, 300, 300],
    }

    df = pd.DataFrame(data=data)
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)

    assert len(best_lines) == 0


def test_no_volume():
    data = {
        "Date": [
            "2024-02-05",
            "2024-02-12",
            "2024-02-19",
            "2024-02-26",
            "2024-03-04",
            "2024-03-11",
            "2024-03-18",
            "2024-03-25",
            "2024-04-02",
            "2024-04-08",
        ],
        "Open": [25.4, 27.0, 26.8, 26.8, 25.8, 26.2, 26.0, 26.2, 25.2, 26.0],
        "High": [26.8, 27.0, 26.8, 26.8, 26.2, 26.6, 26.2, 26.2, 26.2, 26.2],
        "Low": [24.8, 25.4, 25.4, 25.4, 25.4, 25.4, 25.2, 25.2, 25.0, 25.0],
        "Close": [26.0, 26.4, 25.6, 25.8, 26.2, 26.2, 25.2, 26.0, 25.0, 25.0],
        "Volume": [657, 259, 383, 298, 83, 435, 420, 128, 20, 175],
        "RSI": [80, 71, 48, 69, 51, 51, 68, 64, 75, 70],
        "ema5": [
            26.153542,
            26.235695,
            26.023796,
            25.949198,
            26.032798,
            26.088532,
            25.792355,
            25.861570,
            25,
            25.382920,
        ],
        "Volume_MA": [313.15, 322.90, 332.15, 325.55, 272.85, 292, 300, 300, 300, 300],
    }
    # we need a longer dataset for rolling windows
    for key, item in data.items():
        data[key] = item + item

    df = pd.DataFrame(data=data)
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)

    assert len(best_lines) != 0


def test_no_ema5_reclaim():
    data = {
        "Date": [
            "2024-02-05",
            "2024-02-12",
            "2024-02-19",
            "2024-02-26",
            "2024-03-04",
            "2024-03-11",
            "2024-03-18",
            "2024-03-25",
            "2024-04-02",
            "2024-04-08",
        ],
        "Open": [25.4, 27.0, 26.8, 26.8, 25.8, 26.2, 26.0, 26.2, 25.2, 26.0],
        "High": [26.8, 27.0, 26.8, 26.8, 26.2, 26.6, 26.2, 26.2, 26.2, 26.2],
        "Low": [24.8, 25.4, 25.4, 25.4, 25.4, 25.4, 25.2, 25.2, 25.0, 25.0],
        "Close": [26.0, 26.4, 25.6, 25.8, 26.2, 26.2, 25.2, 26.0, 25.0, 25.0],
        "Volume": [657, 259, 383, 298, 83, 435, 420, 128, 1054, 175],
        "RSI": [80, 71, 48, 69, 51, 51, 68, 64, 75, 70],
        "ema5": [
            26.153542,
            26.235695,
            26.023796,
            25.949198,
            26.032798,
            26.088532,
            25.792355,
            25.861570,
            26,
            25.382920,
        ],
        "Volume_MA": [313.15, 322.90, 332.15, 325.55, 272.85, 292, 300, 300, 300, 300],
    }
    # we need a longer dataset for rolling windows
    for key, item in data.items():
        data[key] = item + item

    df = pd.DataFrame(data=data)
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)

    assert len(best_lines) == 0


def test_no_diminished_volatility():
    data = {
        "Date": [
            "2024-02-05",
            "2024-02-12",
            "2024-02-19",
            "2024-02-26",
            "2024-03-04",
            "2024-03-11",
            "2024-03-18",
            "2024-03-25",
            "2024-04-02",
            "2024-04-08",
        ],
        "Open": [25.4, 27.0, 26.8, 26.8, 25.8, 26.2, 26.0, 26.2, 25.2, 26.0],
        "High": [26.8, 27.0, 26.8, 26.8, 26.2, 26.6, 26.2, 26.2, 26.2, 26.2],
        "Low": [24.8, 25.4, 25.4, 25.4, 25.4, 25.4, 25.2, 25.2, 25.0, 25.0],
        "Close": [26.0, 26.4, 25.6, 25.8, 26.2, 26.2, 25.2, 26.0, 25.0, 25.0],
        "Volume": [657, 259, 383, 298, 83, 435, 420, 128, 1054, 175],
        "RSI": [80, 71, 48, 69, 51, 51, 68, 64, 75, 70],
        "ema5": [
            26.153542,
            26.235695,
            26.023796,
            25.949198,
            26.032798,
            26.088532,
            25.792355,
            25.861570,
            25,
            25.382920,
        ],
        "Volume_MA": [313.15, 322.90, 332.15, 325.55, 272.85, 292, 300, 300, 300, 300],
    }

    df = pd.DataFrame(data=data)
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)

    assert len(best_lines) == 0


def test_not_enough_space_between_line_points():
    data = {
        "Date": [
            "2024-02-05",
            "2024-02-12",
        ],
        "Open": [25.4, 27.0],
        "High": [26.8, 27.0],
        "Low": [24.8, 25.4],
        "Close": [26.0, 26.4],
        "Volume": [657, 259],
        "RSI": [50, 71],
        "Volume_MA": [313.15, 322.90],
    }

    df = pd.DataFrame(data=data)
    best_lines = []

    get_best_valid_line(best_lines, "", df, 10)

    assert len(best_lines) == 0
